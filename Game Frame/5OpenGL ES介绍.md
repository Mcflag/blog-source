title: 5OpenGL ES介绍
date: 2015-09-05 22:27:34
tags: [游戏框架]
---

##摘要
OpenGL ES介绍
<!--more-->

##简介

OpenGL ES有1.0版本，1.1版本，2.0版本以及最新发布的3.0版本。比较常用的有1.x版本和2.0版本。OpenGL ES的2.0版本不兼容1.x版本。两者不能够同时使用。其中原因是1.x版本使用的是一种称为固定渲染管道（fixed-function pipeline）的编程模型。而2.0版本允许通过着色器以编程方式定义部分渲染管道，称为shader。大多数设备已经支持了2.0，但是学习使用着色器进行3D编程不太容易。OpenGL ES简单来说是一个精简有效的三角渲染器。

##OpenGL ES的编程模型

* 对象(模型)：通常有4组属性：几何形状、颜色、纹理和材质。几何形状是由一组三角形描述的，每个三角形由空间中的3个点组成。颜色使用RGB值表示。
* 光源：OpenGL ES提供了一组有着多种属性的不同类型的光源。他们只是在3D空间中有着位置和方向的数学意义上的对象，并添加诸如颜色等属性。
* 照相机：这也只是一个空间中有着位置和方向的数学意义上的对象，照相机及其他参数定义了一个视锥，照相机可以拍摄到这个锥体范围内的任何对象，而视锥之外的对象不会包含在最终图像中。
* 视口：它定义了最终图像的大小和分辨率。

##投影

OpenGl ES需要知道这些3D空间点在帧缓冲区的像素坐标系统中的坐标，才能够把三角形渲染到帧缓冲区中。

* 平行或正交投影：对象在最终图像中始终具有同样的大小，OpenGL ES使用此类投影渲染2D图像。
* 透视投影：距离越远投影越小。OpenGL ES使用此类投影进行3D图像处理。

这两种投影都需要一个投影面，是视锥顶层的矩形，它被称为近裁剪面。

##规范化设备空间和视口

只要计算出三角形在近裁剪面上的投影点，就可以转换成帧缓冲区中的像素坐标。计算的公式是

	pixelX=(norX+1)/(viewportWidth+1)+norX
	pixelY=(norY+1)/(viewportHeight+1)+norY

norX和norY是一个3D空间点在规范化设备空间中的坐标，viewportWidth和viewportHeight是视口分别在x轴和y轴上的取值，单位为像素。

##矩阵

OpenGL ES采用矩阵的形式来描述投影：

* 用矩阵对变换进行编码后，这个变换就可以应用到一个点上。这个变换可以是投影、平移、旋转或者是缩放等。
* 通过矩阵与点相乘的方式可以把变换应用到点上。
* 通过矩阵相乘的方式，可以把一连串独立的变换矩阵整合成一个矩阵，当将这个矩阵与一个点相乘是，所有的变换都将施加到这个点上。
* 有一个称为单位矩阵的特殊矩阵，将它与其他矩阵或点相乘，不会有任何变化。

有3种矩阵应用到点上：

* 模型视图矩阵：这种矩阵可以用来移动、旋转或缩放三角形的点（模型部分）。这种矩阵也可以用来确定照相机的位置和方向（视图部分）。
* 投影矩阵：则种矩阵编码投影以及对应照相机的视锥。
* 纹理矩阵：这种矩阵允许我们操作纹理坐标。这部分会在一些设备上出现问题，因此这种矩阵会避免使用。

##渲染管道

OpenGL ES会对这3种矩阵进行记录，每次对矩阵赋值之后，OpenGL ES会一直保持这个矩阵，直到矩阵被再次赋值。按照OpenGl ES的说法，这称为一个状态。OpenGL ES不仅记录矩阵的状态，还记录诸如是否设置半透明混合处理、是否需要考虑光照、是否需要对几何形状设置纹理等。OpenGL ES实际上是一个巨大状态机，需要设置它的当前状态，输入对象的几何形状，并告诉它渲染一幅图像。

该管道处理一个三角形的流程如下：

* 首先用模型视图矩阵对三角形进行变换，则意味着三角形的所有点都与这个矩阵相乘。该乘法可以在世界中移动三角形的点。
* 上述步骤的结果再与投影矩阵相乘，将3D空间点映射到2D的投影面上。
* 在执行上述两步之间（或与他们同时进行），设置三角形需要的光线、材质和颜色。
* 上述步骤全部完成之后，通过应用视口变换，用“视网膜”对投影的三角形进行裁剪，并将其转换成帧缓冲区坐标。
* OpenGL将带有颜色的三角形的像素填充到帧缓冲区中，颜色由光线、三角形的纹理和混合状态产生，其中混合状态标识三角形的每个像素是否与帧缓冲区中对应的像素进行组合。

OpenGL ES执行投影时，实际上并不是投影到2D坐标系统上，而是投影到一个四维齐次坐标系统上，这是一个非常复杂的数学问题，为简单处理，认为OpenGL ES是投影到2D坐标系统上。